---
id: TD-228.1
title: "**D.1 CTAS: Silver facts (examples)**"
source_doc: "TechDevBlueprint.docx"
source_path: "docs\blueprints\tech\TD-228-113d-expanded-silvergold-modeling\TD-228.1-d1-ctas-silver-facts-examples.md"
parent_id: TD-228
anchor: "TD-228.1"
checksum: "sha256:5f0f7e1b0adea5b60aa5d7f7a5b13f5ab125299a102efdbaa51b0f9af35f1a67"
last_modified: "2025-11-06T20:40:46Z"
doc_kind: "TD"
h_level: 3
---
<a id="TD-228.1"></a>
### **D.1 CTAS: Silver facts (examples)**

- Search impressions (Silver)

*CREATE TABLE IF NOT EXISTS silver.fact_search_impressions*  
*WITH (format='PARQUET', parquet_compression='SNAPPY', partitioned_by=array\['dt'\]) AS*  
*SELECT*  
*date_format(received_at, '%Y-%m-%d') AS dt,*  
*received_at,*  
*coalesce(user_id, anon_id) AS actor_key,*  
*(payload_json -\>\> 'query_hash') AS query_hash,*  
*(payload_json -\>\> 'result_pos')::int AS result_pos,*  
*(payload_json -\>\> 'target_type') AS target_type,*  
*(payload_json -\>\> 'target_id') AS target_id,*  
*city,*  
*context.role AS role,*  
*ids\['impression_id'\] AS impression_id*  
*FROM (*  
*SELECT event, received_at, user_id, anon_id, city, context, ids,*  
*json_parse(payload) AS payload_json*  
*FROM bronze_events*  
*WHERE event='search.card_impression' AND env='prod'*  
*) b;*  

- **Booking legs snapshot stream (Silver)**  
  (built from *leg.\** status events + finance webhooks)

*CREATE TABLE IF NOT EXISTS silver.fact_booking_legs*  
*WITH (format='PARQUET', parquet_compression='SNAPPY', partitioned_by=array\['dt'\]) AS*  
*SELECT*  
*date_format(received_at, '%Y-%m-%d') AS dt,*  
*ids\['leg_id'\] AS leg_id,*  
*max_by(payload_json, received_at) AS latest_payload, -- snapshot reducer*  
*max(received_at) AS last_event_at*  
*FROM (*  
*SELECT event, received_at, ids, json_parse(payload) AS payload_json*  
*FROM bronze_events*  
*WHERE event LIKE 'leg.%' AND env='prod'*  
*) s*  
*GROUP BY 1, 2;*  

For full fidelity, prefer **dbt** incremental models on Athena to express joins across *leg.\**, *refund.\**, *payout.\**.
