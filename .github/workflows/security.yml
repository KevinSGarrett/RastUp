name: Security Gates

on:
  pull_request:
    paths:
      - '**/*.py'
      - '**/*.ps1'
      - '**/*.sh'
      - 'orchestrator/**'
      - 'scripts/**'
      - '.github/workflows/security.yml'
  workflow_dispatch:

jobs:
  secrets-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Gitleaks (secrets scanner)
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          args: detect --source . --no-git -v --redact

  bandit-sast:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit
      - name: Run Bandit (collect all severities)
        run: |
          bandit -r orchestrator scripts -ll -x .venv -f json -o bandit.json || true
      - name: Fail on HIGH severity Bandit findings
        run: |
          python - <<'PY'
          import json, sys
          data = json.load(open('bandit.json', 'r', encoding='utf-8'))
          highs = [r for r in data.get('results', []) if r.get('issue_severity','').upper()=='HIGH']
          if highs:
              print(f"Found {len(highs)} HIGH Bandit findings")
              sys.exit(1)
          print("No HIGH Bandit findings")
          PY
      - uses: actions/upload-artifact@v4
        with:
          name: bandit-report
          path: bandit.json
