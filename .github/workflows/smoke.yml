name: Orchestrator Smoke

on:
  workflow_dispatch:
  push:
    paths:
      - 'scripts/**'
      - 'orchestrator/**'
      - 'docs/blueprints/**'
      - 'ops/**'
  schedule:
    - cron: '17 3 * * *'  # nightly

jobs:
  smoke-linux:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Normalize LF for shell scripts (avoid CRLF in WSL/Ubuntu)
        run: |
          sudo apt-get update -y
          sudo apt-get install -y dos2unix
          dos2unix scripts/smoke/*.sh || true
      - name: Run Agent-1 smoke (Linux)
        shell: bash
        run: |
          bash scripts/smoke/agent1.sh
          cat docs/test-reports/smoke/agent1-linux.log
      - name: Upload smoke log (Linux)
        uses: actions/upload-artifact@v4
        with:
          name: smoke-linux-log
          path: docs/test-reports/smoke/agent1-linux.log

  smoke-windows:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Agent-1 smoke (Windows)
        shell: powershell
        run: |
          powershell -ExecutionPolicy Bypass -File scripts\smoke\agent1.ps1
          Get-Content .\docs\test-reports\smoke\agent1-windows.log
      - name: Upload smoke log (Windows)
        uses: actions/upload-artifact@v4
        with:
          name: smoke-windows-log
          path: docs/test-reports/smoke/agent1-windows.log

  concordance:
    runs-on: ubuntu-latest
    if: ${{ hashFiles('scripts/concordance/check_concordance.py') != '' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Concordance NT/TD in queue
        run: |
          python scripts/concordance/check_concordance.py
