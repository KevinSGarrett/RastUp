name: Progress & Outline

on:
  workflow_dispatch:
  push:
    paths:
      - 'orchestrator/**'
      - 'ops/queue.jsonl'
      - 'docs/blueprints/sections.json'
      - '.github/workflows/progress-outline.yml'
  schedule:
    - cron: '35 03 * * *'

permissions:
  contents: write

jobs:
  render:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install deps (if any)
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Render PROGRESS & OUTLINE
        run: |
          python orchestrator/progress.py
          python orchestrator/render_outline.py

      - name: Commit changes (if any)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if git status --porcelain | grep -qE 'docs/PROGRESS\.md|docs/OUTLINE\.md'; then
            git config user.name "orchestrator-bot"
            git config user.email "orchestrator-bot@users.noreply.github.com"
            git add docs/PROGRESS.md docs/OUTLINE.md
            git commit -m "docs(progress): refresh PROGRESS.md & OUTLINE.md [skip ci]"
            git push https://orchestrator-bot:${GH_TOKEN}@github.com/${{ github.repository }} HEAD:${{ github.ref_name }}
          else
            echo "No changes to commit."
          fi
